open Tsdl

let sdl_initialized = ref false
let sdl_window = ref None
let sdl_renderer = ref None

let init_sdl () =
  if not !sdl_initialized then (
    match Sdl.init Sdl.Init.video with
    | Error (`Msg e) -> Sdl.log "SDL Init error: %s" e; exit 1
    | Ok () ->
      match Sdl.create_window ~w:640 ~h:480 "ABCL SDL" Sdl.Window.windowed with
      | Error (`Msg e) -> Sdl.log "SDL Window error: %s" e; exit 1
      | Ok win ->
        sdl_window := Some win;
        match Sdl.create_renderer win ~index:(-1) ~flags:Sdl.Renderer.accelerated with
        | Error (`Msg e) -> Sdl.log "SDL Renderer error: %s" e; exit 1
        | Ok rend ->
          sdl_renderer := Some rend;
          sdl_initialized := true
  )

let sdl_draw_line x1 y1 x2 y2 =
  init_sdl ();
  match !sdl_renderer with
  | Some rend ->
      Sdl.set_render_draw_color rend 255 0 0 255 |> ignore;
      Sdl.render_draw_line rend x1 y1 x2 y2 |> ignore
  | None -> ()

let sdl_erase_line x1 y1 x2 y2 =
  init_sdl ();
  match !sdl_renderer with
  | Some rend ->
      Sdl.set_render_draw_color rend 255 255 255 255 |> ignore;
      Sdl.render_draw_line rend x1 y1 x2 y2 |> ignore
  | None -> ()

let sdl_present () =
  match !sdl_renderer with
  | Some rend -> Sdl.render_present rend
  | None -> ()

let sdl_clear () =
  match !sdl_renderer with
  | Some rend ->
      Sdl.set_render_draw_color rend 255 255 255 255 |> ignore;
      Sdl.render_clear rend |> ignore
  | None -> ()
